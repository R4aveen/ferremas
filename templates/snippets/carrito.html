{% load static %}
{% block css %}

<link rel="stylesheet" href="../../static/css/style.css">
{% endblock css %}

<header class="text-center my-4">
    <div class="row">
        <div class="col-8  justify-content center"  >        
            <h1>Hola!!! (<span>{{ user.username }}</span>)</h1>
        </div>
        <div class="col-md-4">
            <div class="cart-container position-relative d-inline-block">
                <img src="https://img.icons8.com/?size=100&id=44052&format=png&color=000000" alt="Carrito" class="cart-icon" id="cartIcon">
                <span class="cart-count badge bg-danger position-absolute top-0 start-100 translate-middle" id="cartCount">{{ carrito.length }}</span>
                <div class="dropdown-menu p-3" aria-labelledby="cartIcon" id="cartDropdown">
                    <div id="cartItemsContainer">
                        {% for item in carrito %}
                            <div class="dropdown-item">{{ item.cantidad }} x {{ item.producto.nombre }} - ${{ item.precio }}</div>
                        {% endfor %}
                    </div>
                    <div class="dropdown-divider"></div>
                    <p>Total: $<span id="cartTotal">0.00</span></p>
                    <a href="{% url 'CARRITO' %}" class="btn btn-primary btn-block">Ir al Carrito</a>
                </div>
            </div>
        </div>

    </div>

</header>


<style>
    .orden{
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 5rem;
    }

    .card{
            border-radius: 25px 25px 25px 25px;
            box-shadow: 0.5rem 0.5rem 2rem black;
            transition: transform 0.6s ease;
    }
    .card:hover{
            box-shadow: 0.5rem 0.5rem 2rem black;
            transform: translate(0, -0.7rem)
    }

    .card-img-top{
            width: 100%;
            height: 200px;
            border-radius: 25px 25px 0 0;
    }
    .btn-producto{
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 250px;
            height: 50px;
            background-color: #e95600;
            font-size: 15px;
            letter-spacing: 4px;
            color: white;
            border-radius: 25px;
    }
    .btn-producto:hover{
            display: flex;
            align-items: center;
            justify-content: center;
            width: 250px;
            height: 50px;
            background-color: black;
            font-size: 15px;
            letter-spacing: 4px;
            color: white;
            border-radius: 25px;
    }
    .cart-container {
    cursor: pointer;
}

.cart-icon {
    width: 50px;
    height: 50px;
}

.cart-count {
    font-size: 0.8rem;
    padding: 0.2em 0.5em;
}

#cartDropdown {
    width: 300px;
    max-height: 400px;
    overflow-y: auto;
}

</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var cartIcon = document.getElementById('cartIcon');
        var cartCount = document.getElementById('cartCount');
        var cartDropdown = document.getElementById('cartDropdown');
        var cartItemsContainer = document.getElementById('cartItemsContainer');
        var cartTotal = document.getElementById('cartTotal');

        // Datos reales del carrito pasados desde el contexto Django
        var carritoItems = {{ carrito|safe }};
        var productosCache = {};

        function obtenerNombreProducto(idProducto) {
            return new Promise((resolve, reject) => {
                if (productosCache[idProducto]) {
                    resolve(productosCache[idProducto]);
                } else {
                    fetch(`/api/productos/${idProducto}/`)
                        .then(response => response.json())
                        .then(data => {
                            productosCache[idProducto] = data.nombre;
                            resolve(data.nombre);
                        })
                        .catch(error => reject(error));
                }
            });
        }

        function actualizarCarrito() {
            // Limpiar el contenido actual
            cartItemsContainer.innerHTML = '';
            var total = 0;
            var itemCount = 0;
            var promises = carritoItems.map(item => {
                return obtenerNombreProducto(item.producto).then(nombreProducto => {
                    var itemElement = document.createElement('div');
                    itemElement.classList.add('dropdown-item');
                    itemElement.textContent = `${item.cantidad} x ${nombreProducto} - $${item.precio}`;
                    cartItemsContainer.appendChild(itemElement);
                    total += item.cantidad * parseFloat(item.precio);
                    itemCount += item.cantidad;
                });
            });

            Promise.all(promises).then(() => {
                cartTotal.textContent = total.toFixed(2);
                cartCount.textContent = itemCount;
            });
        }

        // Mostrar/Ocultar el dropdown del carrito
        cartIcon.addEventListener('click', function() {
            if (cartDropdown.style.display === 'block') {
                cartDropdown.style.display = 'none';
            } else {
                cartDropdown.style.display = 'block';
            }
        });

        // Inicializar el carrito
        actualizarCarrito();
    });
</script>
